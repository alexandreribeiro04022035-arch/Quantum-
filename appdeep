from flask import Flask, request, jsonify, render_template, send_from_directory
import json
import os
import requests

from gerar_json import gerar_json
from gerar_cache import gerar_cache

app = Flask(__name__)

CACHE_KEY = os.getenv("CACHE_KEY", "123")
DEEPSEEK_API_KEY = "sk-2bf58985cf5c45f9977760d8127627e6"

@app.route("/")
def index():
    return render_template("index.html")

@app.route("/login")
def login():
    return render_template("login.html")

@app.route("/qwriter")
def qwriter():
    return send_from_directory("static", "qwriter.html")

@app.route("/escritor")
def escritor():
    return send_from_directory("static", "escritor.html")

@app.route("/writejson")
def writejson():
    return send_from_directory("cache", "writejson.html")

@app.route("/gerar-cache")
def gerar_cache_route():
    key = request.args.get("key")
    if key != CACHE_KEY:
        return jsonify({"erro": "forbidden"}), 403
    try:
        total = gerar_cache()
        return jsonify({"status": "ok", "registros": total})
    except Exception as e:
        return jsonify({"erro": str(e)}), 500

@app.route("/gerar-json")
def gerar_json_route():
    key = request.args.get("key")
    if key != CACHE_KEY:
        return jsonify({"erro": "forbidden"}), 403
    try:
        gerar_json()
        return jsonify({"status": "ok", "msg": "banco.json atualizado"})
    except Exception as e:
        return jsonify({"erro": str(e)}), 500

@app.route("/ia", methods=["POST"])
def ia():
    user_text = request.json.get("texto", "")
    
    arquivos = {"banco": "", "qwriter": "", "login": ""}
    
    try:
        with open("cache/banco.json", "r", encoding="utf-8") as f:
            arquivos["banco"] = json.load(f)
    except:
        arquivos["banco"] = {}
    
    try:
        with open("static/qwriter.html", "r", encoding="utf-8") as f:
            arquivos["qwriter"] = f.read()
    except:
        arquivos["qwriter"] = ""
    
    try:
        with open("templates/login.html", "r", encoding="utf-8") as f:
            arquivos["login"] = f.read()
    except:
        arquivos["login"] = ""
    
    contexto = f"Arquivos: {arquivos}\nPergunta: {user_text}"
    
    headers = {
        "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "model": "deepseek-chat",
        "messages": [
            {"role": "system", "content": "Você é uma IA."},
            {"role": "user", "content": contexto}
        ]
    }
    
    try:
        response = requests.post(
            "https://api.deepseek.com/v1/chat/completions",
            headers=headers,
            json=payload
        )
        resposta = response.json()["choices"][0]["message"]["content"]
    except Exception as e:
        resposta = f"Erro: {str(e)}"
    
    return jsonify({"resposta": resposta})

if __name__ == "__main__":
    app.run()
